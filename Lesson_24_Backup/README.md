# BORGBACKUP

1. Для запуска стенда необиходимо скачать в локальную папку файлы из репозитория и запустиить: `vagrant up` <br/>
а) В файле `script.sh` происходит установка утилиты borgbackup на обе ВМ, настройка ssh_conf
   для `backup-server` создается партиция, форматируется в xfs и мапится в точку `/var/backup1`
   Чтобы не было лишних вопросов в консоли при подключении по ssh, заранее сгенерированный ключ `id_rsa.pub > authorized_keys` кладем в папку `/root/.ssh/`.
   
б) для ВМ `client`, каталог с которой будет бекапится на сервер из шаренной директории в `/var/backup1` копируем в /root/ папку с ключами; файл конфига логов, включающий в logrotate ротацию логов borgbackup, и добавляем задание бэкапа в crontab  - скрипт borg.sh
Через k-min, где k<=5 создасться удаленный репозиторий и первый бэкап., далее бэкапы будут создаваться с интервалом 5 мин:
   
   `[root@client ~]# borg list root@192.168.11.160:/var/backup1/
client_2020-09-19-17-57              Sat, 2020-09-19 17:57:36 [5c7b504700dedf8ff4531ad4b64bbbd55e4b1b112b18cc97e67a346e2d7869a4]
client_2020-09-19-18-00              Sat, 2020-09-19 18:00:04 [26152aaa554ac6295a354dda7b7d308cfc4ce0c3f6359021b0ba7cacd3623420]
client_2020-09-19-18-01              Sat, 2020-09-19 18:01:20 [ccf9adf43d28e531c9b0f6559d90a78d79e8c1d80c897855b424faffddcdafae]
client_2020-09-19-18-05              Sat, 2020-09-19 18:05:04 [cbfc901a8d8aaf6efb5bcded00a75828e306fd01f598ef068271e2ecd6cfdf40]
client_2020-09-19-18-07              Sat, 2020-09-19 18:07:37 [f946d12b6058b97d5ceb64078479b61984b28004f28a806f713adbbeca2a8e03]
client_2020-09-19-18-10              Sat, 2020-09-19 18:10:03 [a20747fb638b74cb7e41cef554e7ec8242f556125da90321059b0c8ec1a8bc0f]
client_2020-09-19-18-15              Sat, 2020-09-19 18:15:04 [812964227576cb59e332df6ebd3ae6f2a63b5b848a02ed240a2802fa3f830819]
client_2020-09-19-18-20              Sat, 2020-09-19 18:20:04 [8a9d187c2e8cf31961f78f828d2f9a182de39b9716ad67d0ad6a359c201ce5d9]
client_2020-09-19-18-25              Sat, 2020-09-19 18:25:04 [7bcb5d0be5d4584dbdd286c6741bbebd03e9f1a159dfe8d035de32abced6e210]
client_2020-09-19-18-30              Sat, 2020-09-19 18:30:03 [7bee3175d12d337954fdf91a57f279ae46228f00d0fe44438a1fcdf33c217905]
client_2020-09-19-18-35              Sat, 2020-09-19 18:35:04 [8e3d38538fa7515413db2788dffd3ea056064d5f78e0c761374bbe1972a64607]
client_2020-09-19-18-40              Sat, 2020-09-19 18:40:04 [efd78f828333c90da0e3580e9719ba4d96de3f9f7bdea6c502f9fd32bb3dfcb0]`
   
Так как бэкап делается раз в 5 минут, то запустив команду на удаление старых бекапов, мы потеряем все бэкапы кроме последнего, поэтому я немного модифицировал условие: <br/>
  `borg prune -v --list --keep-within=4H --keep-daily=92 --keep-monthly=9 root@$Host:$backup_repo` <br/>
данная команда сохранит все бэкапы за последние 4 часа, а также за предшествующие 92 дня (3 месяца) оставит по одному бэкапу  и далее за оставшиеся 9 месяцев тоже по одному. 
 
#Extract

В случае если каталог `etc` будет удален востановиться с удаленного репозитория не получится, как минимум из-за отсутствия конфигов ssh невозможно будет поднять соединение с удаленым сервером. Чтобы востановиться придется в таком случае, как вариант грузится с LiveCD, смонтировать корневой каталог (например в /mnt), скопировать каталог `etc` c LiveCD в /mnt/etc, перезагрузится в систему и востановить актуальный каталог с помощью средств borg extract. Но это долго и неудобно, гараздо проще создать локальный репозиторий без шифрования:
`borg init --encryption=none /home/etc_backup/`
Сделать 1 бэкап
borg create -v --stats /home/etc_backup/::'{now:%Y-%m-%d-%H-%M}' /etc/
И далее в случае проблем сперва из локальной репы востановиться:
`cd / && borg extract /path/to/repo::2020-09-19-20-38`
а затем на актуальный бэкап из удаленной:
`borg extract root@SERV_IP:/path/to/repo::client_LAST_TIME`








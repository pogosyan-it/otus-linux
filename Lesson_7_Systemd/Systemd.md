# SYSTEMD

Для запуска стенда необходимо скачать папку files:<br/>
<https://github.com/pogosyan-it/otus-linux/tree/master/Lesson_7_Systemd/files>
и поднять ВМ `vagrant up`

1.  Написать service, который будет раз в 30 секунд мониторить лог на предмет наличия ключевого слова (файл лога и ключевое слово должны задаваться в /etc/sysconfig);
 С помощью скрипта `random_log.sh` пишется в лог `/var/log/messages` строка из файла `/etc/sysconfig/serv_mon.conf` раз в 30-40с (время ожидания выбирается произвольно в этом промежутке). Скрипт `log_count.sh` при каждом запуске записывает в файл `/home/vagrant/report.txt` текущее время и кол-во строк в логе с ключевой фразой. Для того, чтобы раз в 30 с. запускался скрипт был написан сам сервис `logmon.service` и таймер `gmon.timer` Важно отметить, что по умолчанию, даже если указано параметр `OnCalendar=*:*:0/30` скрипт все равно через некоторое время будет запускаться раз в 1мин. Для того, чтобы получить именно интервал в 30с необходимо указать параметр `AccuracySec=1us` <br/>
 Все команды установки пакетов, запуск и копирование/рактирование конфигурац. файлов прописаны в самом Vagrantfile и в скрипте `scripts.sh` который запускается при старте ВМ (прописан в Vagranfile)
 
2. Из репозитория epel установить spawn-fcgi и переписать init-скрипт на unit-файл (имя service должно называться так же: spawn-fcgi);
После установки в файле ` /etc/init.d/spawn-fcgi` видим строку `config="/etc/sysconfig/spawn-fcgi"`, редактируем файл `/etc/sysconfig/spawn-fcgi` - раскомментируем в нем настройки. В файле `spawn-fcgi.service` в разделе [Service] прописываем в параметре Environment пусть к файлу `/etc/sysconfig/spawn-fcgi`, а в параметре ExecStart пусть к бинарнику - `/usr/bin/spawn-fcgi -n $OPTIONS`. После команды `systemctl daemon-reload` сервис успешно поднимается. (Предварительно при старте были уже установлены необходимые пакеты -  spawn-fcgi php-cgi httpd)

3. Дополнить unit-файл httpd (он же apache) возможностью запустить несколько инстансов сервера с разными конфигурационными файлами;
После установки httpd копируем файл `/usr/lib/systemd/system/httpd.service` в `/etc/systemd/system` и переименовывем в `httpd@.service` в котором редактируем всего 1 параметр  - EnvironmentFile, который принимает вид: `/etc/sysconfig/%i`, где под %i понимаются имена инстансов в `/etc/sysconfig/`  - в нашем случае их 2           httpd-inst-1.conf и httpd-inst-2.conf, соответственно для каждого из них нужно создать файлы с настройками  - /etc/httpd/httpd-inst-1.conf и httpd-inst-2.conf которые должны отличатся номером порта на котором работает сервис и pid файлом. Во второй можно прописать порт 8080 и PidFile /var/run/httpd-inst-2.pid, а первый оставить без изменения. После проведения этих монипуляций оба сервиса должны поднятся.
